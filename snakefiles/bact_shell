localrules: all

#define sample_id_pattern wildcard and accessing sample_sheet
import pandas as pd
sip_wild = config['work_dir']+'{sample_id_pattern}_contigs.fasta'
sample_sheet = pd.read_csv(f"{config['output_directory']}sample_sheet.csv")

#AGGREGATION RULE
rule all:
    input: 
        config['shell_target_files']
    run:
        data_contents = os.listdir(config['work_dir'])
        for idx, id in enumerate(sample_sheet["sample_id"]):
            for file in data_contents:
                if id in file:
                    os.system(f"[ -f {config['work_dir']}{file} ] && mv {config['work_dir']}{file} {os.path.dirname(sample_sheet['fa'][idx])}")


#MOB-SUITE
rule mob_recon:
    input:
        mob_suite_sif = config['mob_suite_sif'],
        contigs = config['work_dir']+'{sample_id_pattern}_contigs.fasta'
    output:
        config['output_directory']+'{sample_id_pattern}_mob_recon/chromosome.fasta',
        config['output_directory']+'{sample_id_pattern}_mob_recon/contig_report.txt'
    envmodules:
        'singularity'
    shell:
        """
        singularity run {input.mob_suite_sif} mob_recon --infile {input.contigs} --force --outdir {config[output_directory]}{wildcards.sample_id_pattern}_mob_recon/
        """

rule mob_typer:
    input:
        mob_suite_sif = config['mob_suite_sif'],
        recons = config['output_directory']+'{sample_id_pattern}_mob_recon/chromosome.fasta'
    output:
        config['output_directory']+'{sample_id_pattern}_mob_typer.tab'
    envmodules:
        'singularity'
    shell:
        """
        singularity run {input.mob_suite_sif} mob_typer --infile {input.recons} --out_file {config[output_directory]}{wildcards.sample_id_pattern}_mob_typer.tab
        """

#RESFINDER
rule resfinder:
    input:
        resfinder_sif = config['resfinder_sif'],
        contigs = config['work_dir']+'{sample_id_pattern}_contigs.fasta'
    output:
        config['output_directory']+"{sample_id_pattern}_resfinder/pheno_table.txt",
        config['output_directory']+"{sample_id_pattern}_resfinder/ResFinder_Hit_in_genome_seq.fsa",
        config['output_directory']+"{sample_id_pattern}_resfinder/ResFinder_Resistance_gene_seq.fsa",
        config['output_directory']+"{sample_id_pattern}_resfinder/ResFinder_results_tab.txt",
        config['output_directory']+"{sample_id_pattern}_resfinder/ResFinder_results.txt"
    envmodules:
        'singularity'
    shell:
        """
        CONTIG_FILENAME=$(basename {input.contigs})
        cp -r {config[shell_tool_configs][resfinder][resfinder_db]} ~/db-resfinder_{wildcards.sample_id_pattern}/
        cp {input.contigs} ~/ 
        singularity run {input.resfinder_sif} run_resfinder.py -ifa ~/$CONTIG_FILENAME -acq -l {config[shell_tool_configs][resfinder][length]} -t {config[shell_tool_configs][resfinder][coverage]} -db_res  ~/db-resfinder_{wildcards.sample_id_pattern}/db_resfinder -o ~/resfinder_output_{wildcards.sample_id_pattern}
        mv -n ~/resfinder_output_{wildcards.sample_id_pattern}/* {config[output_directory]}{wildcards.sample_id_pattern}_resfinder/
        rm -r ~/db-resfinder_{wildcards.sample_id_pattern}/ ~/resfinder_output_{wildcards.sample_id_pattern} ~/$CONTIG_FILENAME
        """


#AMR++
if 'fq1' in sample_sheet.columns:
    rule amrpp:
        input:
            read_1 = config['work_dir']+'{sample_id_pattern}_R1_001.fastq.gz',
            read_2 = config['work_dir']+'{sample_id_pattern}_R2_001.fastq.gz'
        output:
            config['output_directory']+"{sample_id_pattern}_amrpp/ResistomeResults/AMR_analytic_matrix.csv"
        threads: config["shell_tool_configs"]["amr_plusplus"]["threads"]
        conda:
            config["nextflow_env"]
        shell:
            """
            module load singularity
            mkdir -p {config[output_directory]}{wildcards.sample_id_pattern}_amrpp/RunResistome/
            mkdir -p {config[output_directory]}{wildcards.sample_id_pattern}_amrpp/RunRarefaction/
            mkdir -p {config[output_directory]}{wildcards.sample_id_pattern}_amrpp/ResistomeResults/

            read_1_filename=$(basename {input.read_1})
            read_2_filename=$(basename {input.read_2})
            mkdir -p {config[amrpp_repo]}data/raw/{wildcards.sample_id_pattern}
            cp {input.read_1} {config[amrpp_repo]}data/raw/{wildcards.sample_id_pattern}/
            cp {input.read_2} {config[amrpp_repo]}data/raw/{wildcards.sample_id_pattern}/

            cd {config[amrpp_repo]}
            nextflow run main_AmrPlusPlus_v2.nf --threads {threads} -profile singularity --output "nextflow_output_{wildcards.sample_id_pattern}/" -w "work_dir_{wildcards.sample_id_pattern}/" --reads "{config[work_dir]}/raw/{wildcards.sample_id_pattern}/*_R{{1,2}}_001.fastq.gz"
            
            mv -n nextflow_output_{wildcards.sample_id_pattern}/RunResistome/* {config[output_directory]}{wildcards.sample_id_pattern}_amrpp/RunResistome/
            mv -n nextflow_output_{wildcards.sample_id_pattern}/RunRarefaction/* {config[output_directory]}{wildcards.sample_id_pattern}_amrpp/RunRarefaction/
            mv -n nextflow_output_{wildcards.sample_id_pattern}/ResistomeResults/* {config[output_directory]}{wildcards.sample_id_pattern}_amrpp/ResistomeResults/
            rm -r data/raw/{wildcards.sample_id_pattern} work_dir_{wildcards.sample_id_pattern}/ nextflow_output_{wildcards.sample_id_pattern}/
            """


#MLST
rule mlst: 
    input: 
        mlst_quast_path = config['mlst_quast_sif'],
        contigs = config['work_dir']+'{sample_id_pattern}_contigs.fasta'
    output:
        mlst_output = config['output_directory']+'{sample_id_pattern}_mlst_output.csv',
    threads: 4
    envmodules:
        'singularity'
    shell:
        """
        singularity run {input.mlst_quast_path} mlst --csv {input.contigs} >> {output.mlst_output}
        """


#RGI
rule res_gen_id: 
    input: 
        contigs = config['work_dir']+'{sample_id_pattern}_contigs.fasta'
    output:
        config['output_directory']+'{sample_id_pattern}.rgi.txt',
        config['output_directory']+'{sample_id_pattern}.rgi.json'
    threads: 4
    conda:
        config["rgi_env"]
    shell:
        """rgi main --input_sequence {input.contigs} --output_file {config[output_directory]}{wildcards.sample_id_pattern}.rgi --input_type contig --clean"""


#QUAST
rule quast:
    input:
        sif_file = config['mlst_quast_sif'],
        contigs = config['work_dir']+'{sample_id_pattern}_contigs.fasta'
    envmodules:
        'singularity'
    output:
        config['output_directory']+'{sample_id_pattern}_quast/icarus.html'
    shell:
        'singularity run {input.sif_file} quast -o {config[output_directory]}{wildcards.sample_id_pattern}_quast {input.contigs}'